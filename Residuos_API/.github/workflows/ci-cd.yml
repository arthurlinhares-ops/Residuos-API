name: CI/CD - ResÃ­duos SustentÃ¡veis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Etapa 1: Clonar o repositÃ³rio
      - name: ğŸ§¾ Checkout do cÃ³digo
        uses: actions/checkout@v3

      # Etapa 2: Instalar .NET 8 SDK
      - name: ğŸ§° Instalar .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # Etapa 3: Restaurar dependÃªncias
      - name: ğŸ“¦ Restaurar pacotes
        run: dotnet restore

      # Etapa 4: Build da aplicaÃ§Ã£o
      - name: ğŸ—ï¸ Compilar projeto
        run: dotnet build --configuration Release --no-restore

      # Etapa 5: Testes automatizados (se houver)
      - name: ğŸ§ª Executar testes
        run: dotnet test --no-build --verbosity normal

      # Etapa 6: Build da imagem Docker
      - name: ğŸ³ Build da imagem Docker
        run: docker build -t residuos-app:latest .

      # Etapa 7: Deploy em Staging
      - name: ğŸš€ Deploy em ambiente de Staging
        if: github.ref == 'refs/heads/main'
        run: |
          docker compose -f docker-compose.yml up -d
          echo "AplicaÃ§Ã£o em Staging iniciada com sucesso"

  production:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ§¾ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ³ Deploy em ProduÃ§Ã£o
        run: |
          echo "Iniciando deploy em produÃ§Ã£o..."
          docker compose -f docker-compose.yml up -d --build
          echo "Deploy em produÃ§Ã£o realizado com sucesso!"

name: CI/CD - Resíduos Sustentáveis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Etapa 1: Clonar o repositório
      - name: 🧾 Checkout do código
        uses: actions/checkout@v3

      # Etapa 2: Instalar .NET 8 SDK
      - name: 🧰 Instalar .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # Etapa 3: Restaurar dependências
      - name: 📦 Restaurar pacotes
        run: dotnet restore

      # Etapa 4: Build da aplicação
      - name: 🏗️ Compilar projeto
        run: dotnet build --configuration Release --no-restore

      # Etapa 5: Testes automatizados (se houver)
      - name: 🧪 Executar testes
        run: dotnet test --no-build --verbosity normal

      # Etapa 6: Build da imagem Docker
      - name: 🐳 Build da imagem Docker
        run: docker build -t residuos-app:latest .

      # Etapa 7: Deploy em Staging
      - name: 🚀 Deploy em ambiente de Staging
        if: github.ref == 'refs/heads/main'
        run: |
          docker compose -f docker-compose.yml up -d
          echo "Aplicação em Staging iniciada com sucesso"

  production:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 🧾 Checkout do código
        uses: actions/checkout@v3

      - name: 🐳 Deploy em Produção
        run: |
          echo "Iniciando deploy em produção..."
          docker compose -f docker-compose.yml up -d --build
          echo "Deploy em produção realizado com sucesso!"
